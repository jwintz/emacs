[project]
name = "emacs"
version = "30.2.0"
description = "GNU Emacs"
channels = ["conda-forge"]
platforms = ["osx-64", "osx-arm64"]

[dependencies]
# Build tools
autoconf = "*"
automake = "*"
make = "*"
pkg-config = "*"
texinfo = "*"

# Required libraries
gnutls = "*"
libxml2 = "*"
ncurses = "*"
zlib = "*"

# Image libraries
giflib = "*"
libjpeg-turbo = "*"
libpng = "*"
libtiff = "*"
lcms2 = "*"

# SVG support (requires cairo and glib stack)
librsvg = "*"
cairo = "*"
glib = "*"
gdk-pixbuf = "*"
pango = "*"
expat = "*"

# JSON support
jansson = "*"

[tasks]
patch = { cwd = "emacs", cmd = """
git checkout . && \
patch -p1 < ../patches/alpha-background.patch && \
patch -p1 < ../patches/system-appearance.patch && \
echo 'Patches applied successfully.'
""", description = "Apply patches to emacs submodule" }

# Revert patches by restoring emacs submodule to clean state
unpatch = { cwd = "emacs", cmd = "git checkout .", description = "Revert all patches in emacs submodule" }

# Bootstrap autoconf files (only run once)
bootstrap = { cwd = "emacs", cmd = "./autogen.sh", description = "Generate configure script from configure.ac" }

# Configure for macOS with NS support (run after bootstrap)
configure = { cwd = "emacs", cmd = """
./configure \
  --with-ns \
  --with-gnutls \
  --with-json \
  --with-xml2 \
  --with-rsvg \
  --with-modules \
  --without-x \
  --without-dbus \
  CFLAGS='-O2 -g' \
  LDFLAGS="-Wl,-rpath,$CONDA_PREFIX/lib" \
  PKG_CONFIG_PATH="$CONDA_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH" \
  RSVG_CFLAGS="-I$CONDA_PREFIX/include/librsvg-2.0 -I$CONDA_PREFIX/include/gdk-pixbuf-2.0 -I$CONDA_PREFIX/include/cairo -I$CONDA_PREFIX/include/glib-2.0 -I$CONDA_PREFIX/lib/glib-2.0/include" \
  RSVG_LIBS="-L$CONDA_PREFIX/lib -lrsvg-2 -lm -lgdk_pixbuf-2.0 -lcairo -lgio-2.0 -lgobject-2.0 -lglib-2.0"
""", description = "Configure Emacs with NS support" }

# Build Emacs (requires configure to have been run)
build = { cwd = "emacs", cmd = "make -j$(sysctl -n hw.ncpu)", description = "Build Emacs" }

# Install into nextstep directory (requires build)
install = { cwd = "emacs", cmd = "make install && codesign --force --deep --sign - ./nextstep/Emacs.app", description = "Install Emacs.app to nextstep/ and sign" }

# Run the built Emacs (rebuilds if needed)
run = { cwd = "emacs", cmd = "./nextstep/Emacs.app/Contents/MacOS/Emacs", description = "Run Emacs.app (rebuilds if needed)" }

# Clean build artifacts
clean = { cwd = "emacs", cmd = "make clean", description = "Clean build artifacts" }

# Deep clean including configure
distclean = { cwd = "emacs", cmd = "make distclean 2>/dev/null || true", description = "Clean everything including configure output" }

# Run the test suite
check = { cwd = "emacs", cmd = "make check", description = "Run Emacs test suite" }

[environments]
default = { features = [], solve-group = "default" }

